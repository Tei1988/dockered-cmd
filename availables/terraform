#!/bin/sh -e

if [ "x${TERRAFORM_BASE_DIR}" = 'x' ]; then
    echo "try to define TERRAFORM_BASE_DIR as environment variable if error occured on module loading."
fi
TERRAFORM_MOUNT_POINT=$(realpath "${TERRAFORM_BASE_DIR:-./}")
TERRAFORM_WORKDIR=$(realpath --relative-to=${TERRAFORM_MOUNT_POINT} ${PWD})

. "$(dirname "$(readlink "$0")")/../libs/user_option.sh"
USER_OPTION=$(user_option)

if [ ! -d "${HOME}/.config/gcloud" ]; then
    mkdir -p "${HOME}/.config/gcloud"
fi

DOCKER_IMAGE="hashicorp/terraform:0.12.28"
docker run ${USER_OPTION} -w "/src/${TERRAFORM_WORKDIR}" -v "${TERRAFORM_MOUNT_POINT}:/src" -v "${HOME}/.config/gcloud:/.config/gcloud:ro" --rm "${DOCKER_IMAGE}" "$@"
